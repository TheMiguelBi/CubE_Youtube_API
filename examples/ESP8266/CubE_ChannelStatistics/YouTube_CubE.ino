#include <YoutubeApi.h>

/*******************************************************************
    An example of bot that echos back any messages received
 *                                                                 *
    written by Giacarlo Bacchio (Gianbacchio on Github)
    adapted by Brian Lough
    OLED code added by TheMiguelBi
 *******************************************************************/

// ESP8266
#include <ESP8266WiFi.h>
#include <WiFiClientSecure.h>

// OLED
#include <Arduino.h>
#include <U8g2lib.h>

#ifdef U8X8_HAVE_HW_SPI
#include <SPI.h>
#endif
#ifdef U8X8_HAVE_HW_I2C
#include <Wire.h>
#endif

#define MB_width 128
#define MB_height 64
static unsigned char MB_bits[] = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x0f, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8,
   0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xfc, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x38, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e,
   0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x0e, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x70, 0x00, 0x0c, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x07,
   0xe0, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0xfc, 0x03, 0x07, 0xe0, 0xe0, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xcf, 0x03, 0xe0, 0xfb, 0x7b, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8f, 0xff, 0x03,
   0xc0, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x80, 0x07, 0xfc, 0x00, 0x00, 0x1f, 0xe0, 0x01, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0xc0, 0x03, 0x30, 0x00, 0x00, 0x04, 0xc0, 0x01,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x01, 0x00, 0x00,
   0x00, 0x00, 0xc0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0xc0, 0x01, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x01, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x64, 0x00, 0x00, 0xc0, 0x01,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x64,
   0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x07, 0x00, 0xf6, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0xd6, 0x01, 0x60, 0x70, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x04, 0xcf,
   0x03, 0xf0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x0e, 0x84, 0xc7, 0x03, 0xf8, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0xc4, 0xc7, 0x03, 0xe4, 0x31, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0xfe, 0xc7,
   0xe3, 0xe1, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x06, 0xc7, 0xc7, 0x03, 0xe0, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x80, 0x87, 0xc7, 0xc7, 0x03, 0xe0, 0xe1, 0x03,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xe7, 0xc7, 0xc7,
   0xfb, 0xe3, 0xe1, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0xfc, 0x81, 0xc7, 0xc7, 0xe3, 0xe3, 0x81, 0x7f, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0xc7, 0xc7, 0xe3, 0x23, 0x00, 0xfc,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x80, 0xc7, 0xc7,
   0xe3, 0x73, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x03, 0x80, 0xc7, 0xc7, 0xe3, 0xfb, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0xc7, 0xc7, 0xe3, 0xeb, 0x01, 0xc0,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0xc7, 0xc7,
   0xe3, 0xe3, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x03, 0x80, 0xd7, 0xc7, 0xe3, 0xe3, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0xd7, 0xc7, 0xe3, 0xe3, 0x01, 0xe0,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0xcf, 0xc7,
   0xe3, 0xe3, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x0f, 0x00, 0xcc, 0xc7, 0xe3, 0xe3, 0x01, 0xf8, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0xc6, 0xc7, 0xe3, 0xe3, 0x01, 0x7f,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x81, 0xc7, 0xcf,
   0xe3, 0xe3, 0xcd, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0xf0, 0x87, 0xc7, 0xc0, 0xe3, 0xe3, 0xe3, 0x07, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x80, 0x87, 0x07, 0xc0, 0xe3, 0xe3, 0xe0, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8e, 0x07, 0xc0,
   0xe3, 0x73, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x8e, 0xe7, 0xc0, 0xe3, 0x27, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x8e, 0x17, 0xc0, 0xe3, 0x21, 0x38, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x0f, 0xc0,
   0xe3, 0x20, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x0e, 0x06, 0x80, 0x73, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x6b, 0x00, 0xe0, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00,
   0x26, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x07, 0x00, 0x00, 0x26, 0x00, 0xc0, 0x01, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0x02, 0x00, 0xc0, 0x01,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00,
   0x02, 0x00, 0x80, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0xc0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0xc0, 0x03, 0x30, 0x00, 0x00, 0x0e, 0xc0, 0x03,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x07, 0xfc, 0x01,
   0x80, 0x7f, 0xe0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x8f, 0xff, 0x03, 0xc0, 0xff, 0xf1, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xcf, 0x07, 0xe0, 0xf1, 0x7f, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x03, 0x07,
   0xe0, 0x80, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x78, 0x00, 0x07, 0xe0, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x70, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e,
   0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x1c, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x38, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8,
   0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xf8, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00 };

// OLED: SCL = D1, SDA = D2
U8G2_SH1106_128X64_NONAME_1_SW_I2C u8g2(U8G2_R0, /* clock=*/ SCL, /* data=*/ SDA, /* reset=*/ U8X8_PIN_NONE);   // All Boards without Reset of the Display

//------- Replace the following! ------
char ssid[] = "xxxx";       // your network SSID (name)
char password[] = "yyyy";  // your network key
#define API_KEY "yourApiToken"  // your google apps API Token
#define CHANNEL_ID "YourChannelId" // makes up the url of channel
IPAddress ip(0, 0, 0, 0);          // Your IP Address
IPAddress gateway(0, 0, 0, 0);       // Your GateWay Address
IPAddress subnet(255, 255, 255, 0);   // Your Subnet Address

WiFiClientSecure client;
YoutubeApi api(API_KEY, client);

int api_mtbs = 60000; // mean time between api requests (60s)
long api_lasttime;   // last time api request has been done

long subs = 0;

int activeScreen = 1; // The currently displayed OLED screen

int subscriberCount;
int viewCount;
int commentCount;
int videoCount;

//
// =======================================================================================================
// MAIN ARDUINO SETUP (1x during startup)
// =======================================================================================================
//

void setup() {

  Serial.begin(115200);
  
  // Display setup
  Wire.setClock(400); // 400kHz I2C clock
  u8g2.begin();
  u8g2.setFontRefHeightExtendedText();
  u8g2.setFontPosTop();
  u8g2.clearBuffer();          // clear the internal memory
  drawPic();                   // WellcomeImage

  // Set WiFi to station mode and disconnect from an AP if it was Previously
  // connected
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  delay(100);
  WiFi.config(ip, gateway, subnet);

  // Attempt to connect to Wifi network:
  Serial.print("Connecting Wifi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println("");
  Serial.println("WiFi connected");
  Serial.print("IP address: ");
  IPAddress ip = WiFi.localIP();
  Serial.println(ip);
  Serial.print("MAC: ");
  Serial.println(WiFi.macAddress());

  // First get Data
  getApiData();

}

//
// =======================================================================================================
// GET YOUTUBE API 3 DATA
// =======================================================================================================
//

void getApiData() {
  if (api.getChannelStatistics(CHANNEL_ID)) {
    subscriberCount = api.channelStats.subscriberCount;
    viewCount = api.channelStats.viewCount;
    commentCount = api.channelStats.commentCount;
    videoCount = api.channelStats.videoCount;
  }
}

//
// =======================================================================================================
// PRINT SERIAL DATA
// =======================================================================================================
//

void printData() {
  if (millis() > api_lasttime + api_mtbs)  {

    getApiData();

    Serial.println("---------Stats---------");
    Serial.print("Subscriber Count: ");
    Serial.println(subscriberCount);
    Serial.print("View Count: ");
    Serial.println(viewCount);
    Serial.print("Comment Count: ");
    Serial.println(commentCount);
    Serial.print("Video Count: ");
    Serial.println(videoCount);
    Serial.println("------------------------");

    api_lasttime = millis();
  }
}

//
// =======================================================================================================
// DRAW DISPLAY
// =======================================================================================================
//

void drawDisplay() {

  u8g2.firstPage();  // clear screen
  do {
    switch (activeScreen) {
      case 1: // Screen # 1 -----------------------------------

        oledHeader();

        // Subscribers
        u8g2.setFont(u8g2_font_courB14_tf); // u8g_font_9x15
        u8g2.setCursor(3, 20);
        u8g2.print("Subscribers:");
        u8g2.setFont(u8g_font_helvR24); // helvR24
        u8g2.setCursor(3, 35);
        u8g2.print(subscriberCount);
        break;

        case 2: // Screen # 2 -----------------------------------

        oledHeader();

        // Views
        u8g2.setFont(u8g2_font_courB14_tf); // u8g_font_9x15
        u8g2.setCursor(3, 20);
        u8g2.print("Views:");
        u8g2.setFont(u8g_font_helvR24); // helvR24
        u8g2.setCursor(3, 35);
        u8g2.print(viewCount);
        break;

        case 3: // Screen # 3 -----------------------------------

        oledHeader();

        // Views
        u8g2.setFont(u8g2_font_courB14_tf); // u8g_font_9x15
        u8g2.setCursor(3, 20);
        u8g2.print("Comments:");
        u8g2.setFont(u8g_font_helvR24); // helvR24
        u8g2.setCursor(3, 35);
        u8g2.print(commentCount);
        break;

        case 4: // Screen # 4 -----------------------------------

        oledHeader();

        // Videos
        u8g2.setFont(u8g2_font_courB14_tf); // u8g_font_9x15
        u8g2.setCursor(3, 20);
        u8g2.print("Videos:");
        u8g2.setFont(u8g_font_helvR24); // helvR24
        u8g2.setCursor(3, 35);
        u8g2.print(videoCount);
        break;
    }
  } while ( u8g2.nextPage() ); // show display queue
}

void oledHeader() {
  // Header
  u8g2.setFont(u8g_font_6x13); // u8g_font_9x15B
  u8g2.drawStr(5, -2, "The XYZ"); //Your YouTube Channel Name
  // Dividing Line
  u8g2.drawLine(0, 13, 128, 13);
}

//
// =======================================================================================================
// SWICH OLED PAGE
// =======================================================================================================
//

void switchPage() {
  static unsigned long lastSwitch;
  if (millis() - lastSwitch >= 2000) { // Every 2s
    lastSwitch = millis();
    
    // increase the page number
    activeScreen++;
    if ( activeScreen >= 5 )
      activeScreen = 1;
  }
}

//
// =======================================================================================================
// MAIN LOOP
// =======================================================================================================
//

void loop() {

  printData();

  drawDisplay();

  switchPage();

}

void drawPic() {                          // show WelcomeImage
  // picture loop
  u8g2.clearBuffer();
  u8g2.firstPage();  
  do {
      u8g2.drawXBM( 0, 0, MB_width, MB_height, MB_bits);
  } while( u8g2.nextPage() );
}
